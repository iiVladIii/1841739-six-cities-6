import{r,j as s,$ as h,i as p,k as v,S as x,m as j,b as g,c as N,n as b,o as y,p as O,O as C}from"./index-Dl5it23-.js";import{a as R,b as S,H as k}from"./header-Dn6WsPvB.js";import{C as D,s as E}from"./scroll-into-view-D2kBWeh0.js";function u(t){const a=new Date(t),i=["January","February","March","April","May","June","July","August","September","October","November","December"],e=a.getFullYear(),c=i[a.getMonth()],n=a.toISOString().split("T")[0];return{month:c,year:e,dateTime:n,mothYear:`${c} ${e}`}}const $=r.memo(t=>{const{reviews:a}=t,i=r.useCallback(e=>20*e,[]);return a.length===0?null:s.jsx("ul",{className:"reviews__list",children:a.map(e=>s.jsxs("li",{className:"reviews__item",children:[s.jsxs("div",{className:"reviews__user user",children:[s.jsx("div",{className:"reviews__avatar-wrapper user__avatar-wrapper",children:s.jsx("img",{className:"reviews__avatar user__avatar",src:e.user.avatarUrl,width:"54",height:"54",alt:"Reviews avatar"})}),s.jsx("span",{className:"reviews__user-name",children:e.user.name})]}),s.jsxs("div",{className:"reviews__info",children:[s.jsx("div",{className:"reviews__rating rating",children:s.jsxs("div",{className:"reviews__stars rating__stars",children:[s.jsx("span",{style:{width:`${i(e.rating)}%`}}),s.jsx("span",{className:"visually-hidden",children:"Rating"})]})}),s.jsx("p",{className:"reviews__text",children:e.comment}),s.jsx("time",{className:"reviews__time",dateTime:u(e.date).dateTime,children:u(e.date).mothYear})]})]},e.id))})}),H=async({offerId:t,rating:a,comment:i})=>{const e=await h.post(`/comments/${t}`,{rating:a,comment:i});if(!e.data)throw new Error("Could not create review");return e.data},P=async t=>{const a=await h.get(`/comments/${t}`);if(!a.data)throw new Error("Could not find review");return a.data},T=r.memo(t=>{const{id:a,onPost:i}=t,[e,c]=r.useState({rating:0,comment:""}),n=p(),m=r.useCallback(d=>{d.stopPropagation(),d.preventDefault(),a&&H({offerId:a,rating:e.rating,comment:e.comment}).then(l=>{i?.(l),c({rating:0,comment:""})}).catch(l=>v(l))},[a,i,e.comment,e.rating]),f=r.useCallback(d=>{const l=d.target.value;c(w=>({...w,comment:l}))},[]),o=r.useCallback(d=>{c(l=>({...l,rating:d}))},[]),_=r.useMemo(()=>!(e.rating===0||!e.comment||e.comment.length<50||e.comment.length>300),[e.comment,e.rating]);return!n||!a?null:s.jsxs("form",{className:"reviews__form form",action:"#",method:"post",onSubmit:m,children:[s.jsx("label",{className:"reviews__label form__label",htmlFor:"review",children:"Your review"}),s.jsx(x,{className:"reviews__rating-form ",onChange:o}),s.jsx("textarea",{onChange:f,className:"reviews__textarea form__textarea",id:"review",name:"review",value:e.comment,placeholder:"Tell how was your stay, what you like and what can be improved"}),s.jsxs("div",{className:"reviews__button-wrapper",children:[s.jsxs("p",{className:"reviews__help",children:["To submit review please make sure to set"," ",s.jsx("span",{className:"reviews__star",children:"rating"})," and describe your stay with at least"," ",s.jsx("b",{className:"reviews__text-amount",children:"50 characters"}),"."]}),s.jsx("button",{className:"reviews__submit form__submit button",type:"submit",disabled:!_,children:"Submit"})]})]})}),A=t=>t.sort((a,i)=>a.date>i.date?-1:1),M=r.memo(t=>{const{id:a}=t,[i,e]=r.useState([]);r.useEffect(()=>{a&&P(a).then(n=>e(A(n))).catch(n=>v(n))},[a]);const c=r.useCallback(n=>{e(m=>[n,...m])},[]);return s.jsxs("section",{className:"offer__reviews reviews",children:[s.jsxs("h2",{className:"reviews__title",children:["Reviews Â·"," ",s.jsx("span",{className:"reviews__amount",children:i.length})]}),s.jsx($,{reviews:i}),s.jsx(T,{id:a,onPost:c})]})}),J=r.memo(()=>{const{id:t}=j(),a=g(),i=R(),e=S(),[c,n]=r.useState(null),m=N(),f=r.useCallback(o=>{n(o)},[]);return r.useEffect(()=>{t&&(window.scrollTo({top:0,behavior:"smooth"}),a(b(t)).then(o=>{o.meta.requestStatus==="rejected"&&m("/404")}))},[a,t,m]),r.useEffect(()=>{e&&a(y({id:e.id,city:e.city.name}))},[a,e]),e?s.jsxs("div",{className:"page",children:[s.jsx(k,{}),s.jsxs("main",{className:"page__main page__main--offer",children:[s.jsx(O,{offer:e,reviews:s.jsx(M,{id:e.id})}),s.jsx("section",{className:"offer__map map",children:s.jsx(D,{city:e.city.name,offers:[e,...i.slice(0,3)],selectedOffer:e,onPointClick:o=>{E(`#${o}`)}})}),s.jsx("div",{className:"container",children:s.jsxs("section",{className:"near-places places",children:[s.jsx("h2",{className:"near-places__title",children:"Other places in the neighbourhood"}),s.jsx("div",{className:"near-places__list places__list",children:s.jsx(C,{offers:i.slice(0,3),onActiveOffer:f})})]})})]})]}):null});export{J as default};
