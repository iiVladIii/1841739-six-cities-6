import{r as i,j as s,$ as h,i as p,k as v,S as x,m as j,b as g,c as N,n as b,o as y,p as O,O as C}from"./index-329d30e3.js";import{a as R,b as S,H as k}from"./header-d9035330.js";import{C as D,s as E}from"./scroll-into-view-cfbd7a14.js";function u(r){const a=new Date(r),t=["January","February","March","April","May","June","July","August","September","October","November","December"],e=a.getFullYear(),c=t[a.getMonth()],n=a.toISOString().split("T")[0];return{month:c,year:e,dateTime:n,mothYear:`${c} ${e}`}}const $=i.memo(r=>{const{reviews:a}=r,t=i.useCallback(e=>20*e,[]);return a.length===0?null:s.jsx("ul",{className:"reviews__list",children:a.map(e=>s.jsxs("li",{className:"reviews__item",children:[s.jsxs("div",{className:"reviews__user user",children:[s.jsx("div",{className:"reviews__avatar-wrapper user__avatar-wrapper",children:s.jsx("img",{className:"reviews__avatar user__avatar",src:e.user.avatarUrl,width:"54",height:"54",alt:"Reviews avatar"})}),s.jsx("span",{className:"reviews__user-name",children:e.user.name})]}),s.jsxs("div",{className:"reviews__info",children:[s.jsx("div",{className:"reviews__rating rating",children:s.jsxs("div",{className:"reviews__stars rating__stars",children:[s.jsx("span",{style:{width:`${t(e.rating)}%`}}),s.jsx("span",{className:"visually-hidden",children:"Rating"})]})}),s.jsx("p",{className:"reviews__text",children:e.comment}),s.jsx("time",{className:"reviews__time",dateTime:u(e.date).dateTime,children:u(e.date).mothYear})]})]},e.id))})}),H=async({offerId:r,rating:a,comment:t})=>{const e=await h.post(`/comments/${r}`,{rating:a,comment:t});if(!e.data)throw new Error("Could not create review");return e.data},T=async r=>{const a=await h.get(`/comments/${r}`);if(!a.data)throw new Error("Could not find review");return a.data},A=i.memo(r=>{const{id:a,onPost:t}=r,[e,c]=i.useState({rating:0,comment:""}),n=p(),m=i.useCallback(d=>{d.stopPropagation(),d.preventDefault(),a&&H({offerId:a,rating:e.rating,comment:e.comment}).then(o=>{t==null||t(o),c({rating:0,comment:""})}).catch(o=>v(o))},[a,t,e.comment,e.rating]),f=i.useCallback(d=>{const o=d.target.value;c(w=>({...w,comment:o}))},[]),l=i.useCallback(d=>{c(o=>({...o,rating:d}))},[]),_=i.useMemo(()=>!(e.rating===0||!e.comment||e.comment.length<50||e.comment.length>300),[e.comment,e.rating]);return!n||!a?null:s.jsxs("form",{className:"reviews__form form",action:"#",method:"post",onSubmit:m,children:[s.jsx("label",{className:"reviews__label form__label",htmlFor:"review",children:"Your review"}),s.jsx(x,{className:"reviews__rating-form ",onChange:l}),s.jsx("textarea",{onChange:f,className:"reviews__textarea form__textarea",id:"review",name:"review",value:e.comment,placeholder:"Tell how was your stay, what you like and what can be improved"}),s.jsxs("div",{className:"reviews__button-wrapper",children:[s.jsxs("p",{className:"reviews__help",children:["To submit review please make sure to set"," ",s.jsx("span",{className:"reviews__star",children:"rating"})," and describe your stay with at least"," ",s.jsx("b",{className:"reviews__text-amount",children:"50 characters"}),"."]}),s.jsx("button",{className:"reviews__submit form__submit button",type:"submit",disabled:!_,children:"Submit"})]})]})}),M=r=>r.sort((a,t)=>a.date>t.date?-1:1),P=i.memo(r=>{const{id:a}=r,[t,e]=i.useState([]);i.useEffect(()=>{a&&T(a).then(n=>e(M(n))).catch(n=>v(n))},[a]);const c=i.useCallback(n=>{e(m=>[n,...m])},[]);return s.jsxs("section",{className:"offer__reviews reviews",children:[s.jsxs("h2",{className:"reviews__title",children:["Reviews Â·"," ",s.jsx("span",{className:"reviews__amount",children:t.length})]}),s.jsx($,{reviews:t}),s.jsx(A,{id:a,onPost:c})]})}),J=i.memo(()=>{const{id:r}=j(),a=g(),t=R(),e=S(),[c,n]=i.useState(null),m=N(),f=i.useCallback(l=>{n(l)},[]);return i.useEffect(()=>{r&&(window.scrollTo({top:0,behavior:"smooth"}),a(b(r)).then(l=>{l.meta.requestStatus==="rejected"&&m("/404")}))},[a,r,m]),i.useEffect(()=>{e&&a(y({id:e.id,city:e.city.name}))},[a,e]),e?s.jsxs("div",{className:"page",children:[s.jsx(k,{}),s.jsxs("main",{className:"page__main page__main--offer",children:[s.jsx(O,{offer:e,reviews:s.jsx(P,{id:e.id})}),s.jsx("section",{className:"offer__map map",children:s.jsx(D,{city:e.city.name,offers:[e,...t.slice(0,3)],selectedOffer:e,onPointClick:l=>{E(`#${l}`)}})}),s.jsx("div",{className:"container",children:s.jsxs("section",{className:"near-places places",children:[s.jsx("h2",{className:"near-places__title",children:"Other places in the neighbourhood"}),s.jsx("div",{className:"near-places__list places__list",children:s.jsx(C,{offers:t.slice(0,3),onActiveOffer:f})})]})})]})]}):null});export{J as default};
